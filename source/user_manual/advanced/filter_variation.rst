.. _filter-var:

Filter Variation Correction
==========================================

The filter transmission of a detector can be slightly different for objects
observed at different positions on the detector. The variation of filter
transmissions affects photometric measurements and, consequently, it
can also have an effect on the estimation of photometric redshifts.

Phosphoros can take into account filter variations corresponding to a
translation along the wavelength of filter transmission curves. The
information needed by Phosphoros is the amplitude of the shift,
defined as the difference between the actual and the nominal filter
central wavelength,
:math:`\Delta\lambda=\lambda_c^{actual}-\lambda_c^{nominal}`, where
the actual one is the measured central wavelength of the filter
trasmission associated with a specific detected source. This
information is expected to be found in the input catalog, as
additional column, one for each photometric band in which filter
variation is relevant or known.

Before estimating photometric redshifts, Phosphoros computes the
correction due to filter variation that must be applied to modeled
fluxes. In particular, a *filter variation correction grid* is
generated through the following steps:

- users define the set of values of :math:`\Delta\lambda` for which flux
  corrections are computed (e.g., *N* points between -100 to 100
  |AAm|);

- for each model of the grid the flux correction is computed for
  each (selected) photometric band;

- for each model and band the computed flux corrections are fitted as a
  function of the filter variation;

- the coefficients of the fit are saved in the *filter variation correction grid*.

Therefore, through the *filter variation correction grid*, Phosphoros is
able to compute in a fast way the filter variation flux corrections
for each source of the input catalog.


Filter Variation Correction in the GUI
-------------------------------------------------------

In the GUI, users have firstly to map filters to the catalog
columns that contain the filter variation. Go to the ``Catalog Setup``
panel and click on the ``Filter Shift`` control (see the left panel of
:numref:`filt_var`): a new column will appear in the ``Filter
Mapping`` table where users can insert the name of the filter shift
column. After saving, the ``Filter Shift Column`` is included in the
``filter_mapping.txt`` file (see :ref:`Filter Mapping Format<filter-mapping>`).

The *filter variation correction grid* is then computed at the step 2
(``Grids Generation``) of the ``Compute Redshifts`` panel (see the
right panel of :numref:`filt_var`), and stored in the directory::

  > $PHOSPHOROS_ROOT/IntermediateProducts/<Catalog Type>/FilterVariationCoefficientGrids

Users can select the range of the filter variation (in |AAm|) and the
number of sampling points. Clicking on ``Save Config. File``, users
can save the corresponding configuration file.

At this point, in the redshift computation, the flux correction due to
filter variation will be taken into account in all the photometric
bands for which the filter variation column has been provided.

.. figure:: /_static/advanced_steps/filter_var.png
    :name: filt_var
    :align: center 
    :width: 800px
    :height: 400px
	     
    Filter variation correction with the GUI

    
Filter Variation Correction in the CLI
--------------------------------------------------------

In the CLI, the *filter variation correction grid* is generated by the
``Compute Filter Variation Coefficient Grid`` (or ``CFVCG``)
action. The range of the filter variation (i.e., the maximum
negative/positive shift of the filter central wavelength) and the
number of sampling points can be defined by the following options::

  --filter-variation-min-shift=-100 (default value)
  --filter-variation-max-shift=100 (default value)
  --filter-variation-shift-samples=200 (default value)

where the shift is in Angstrom. The output
grid name and the format can be choosen through::

  --output-filter-variation-coefficient-grid=<name>
  --output-filter-variation-coefficient-grid-format=BINARY or TEXT

More options can be found with the ``--help`` parameter, including
model normalization options, Galactic extiction option,
etc. (as for the ``compute_model_grid`` action).

Before running Phosphoros, users should ensure that the
``filter_mapping.txt`` file contains the filter variation column name
of each band for which filter variation correction must be computed
(see :ref:`CLI: Mapping filters to column names<mapping-cli>`). This
operation can be easily done by the GUI (see above). Otherwise, users
have to edit the file and include the information by hand (see
:ref:`Filter Mapping Format<filter-mapping>`).

Finally, the path and the file name of the *filter variation
correction grid* must be specified in the configuration file of the
``compute_redshift`` action, through the option::

  --filter-variation-coefficient-grid-file=<path>/<name>
