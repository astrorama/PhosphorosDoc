.. _luminosity-prior:

Luminosity Priors
=================

Luminosity priors refer to priors that depend on the luminosity or the
absolute magnitude of sources. Luminosity priors are typically
provided by **luminosity functions** that are the space density of
galaxies as a function of the luminosity and, up to a global
normalization, can be seen as probability density functions (see the
:ref:`bayesian-priors` section for more details). Luminosity functions
depend on the wavelength band in which luminosities are measured.

Luminosity Priors Configuration
-------------------------------

First of all, users have to select whether to use the **AB magnitude**
or the **luminosity**, specify the filter at which the luminosity
function is computed, and whether the luminosity has to be corrected
for intrinsic reddening or not.

**Luminosity functions** can be provided to Phosphoros through:

- data files, storing luminosity functions. They must contains two
  columns, the luminosity in [erg/s/Hz] or the AB magnitude, and the
  luminosity function (typically in [:math:`{\rm Mpc}^{-3}\,({\rm
  erg/s/Hz})^{-1}`] or [:math:`{\rm Mpc}^{-3}`]). By
  default, these files are located in the
  ``AuxiliaryData/LuminosityFunctionCurves/`` directory;

-  a Schechter parametrization. The Schechter function has the form:

    .. math::

       n(L)=\frac{\phi^*}{L^*}\bigg(\frac{L}{L^*}\bigg)^{\alpha_s}\,e^{-L/L^*}

    .. math::   
       ~~~~~~{\rm or}~~~~~~

    .. math::
       
       n(M)=0.921\,\phi^*\,x^{\alpha_s+1}\,e^{-x}\,

   with :math:`x=10^{-0.4(M-M^*)}`. Users have to provide the values
   for the parameters :math:`\alpha_s,~\phi^*` in [:math:`{\rm
   Mpc}^{-3}`] and :math:`M^*~{\rm or}~L^*` in [erg/s/Hz].

Luminosity functions can vary according to SED templates and redshift
ranges. Users have the possibility to define different luminosity
functions for different redshift ranges and SED groups.

..
  Note that the relative normalization between the different luminosity function is independent
  of the number of SED in the groups.

.. note::

   The units of luminosity functions are not relevant for Phosphoros as
   long as they are the same in all redshift/SED template cells.
  
.. note::

   The filter which the luminosity function is defined for is not
   necessarily one of the filters used for the photometric
   measurements.

..   In that case, a file containing the filter
     transmission curve has to be found below the
     ``AuxiliaryData/Filters/`` directory.


In order to apply luminosity priors, Phosphoros needs to compute the
source luminosity for the filter used to define the luminosity
function, :math:`L_b`. This is done in two steps. First, a
**luminosity model grid** is generated by computing the flux in the
filter, :math:`f^b_m`, for each model of the grid, with a restricted
parameter space to redshift :math:`z=0`. In the second
step, luminosities are computed taking into account the redshift and
the normalization factor :math:`\alpha` of each model (see the
:ref:`Template fitting method <template-fitting>` section) by the
relation :math:`L_b=4\pi\alpha D_L^2f^b_m`, where :math:`D_L` is the
luminosity distance.

.. note::
   
   The GUI will automatically compute the luminosity model grid when
   the redshift computation is launched. On the other hand, the CLI
   usage requires to compute this grid before launching the redshifts
   computation (see below).

.. note::

   The volume prior is automatically added by Phosphoros to luminosity
   priors.


Luminosity Priors in the GUI
---------------------------------

Users can check the list of the available luminosity functions in
``Configuration --> Aux. Data --> Luminosity Function
Curves``. New luminosity functions can be added using the ``Import
Folder`` button or simply by the shell command ``cp``.

Luminosity priors are applied by clicking on the ``3. Prior``
sub-panel in the ``Compute Redshifts`` window and selecting
``Luminosity Prior``. Users can select previously defined luminosity
priors from the nearby drop-down list. Otherwise, clicking on the
``Configure Luminosity Prior`` button, a popup window allows to create
new luminosity priors or to manage the existing ones
(:numref:`lumprior`).

.. figure:: /_static/advanced_steps/lum_prior1.png
    :name: lumprior 
    :align: center
    :width: 800px
    :height: 400px
	     
    Introducing luminosity priors with the GUI

As seen from the image, some information are required in the middle of
the panel: the ``Name`` of the prior; the ``Prior Type``, i.e.,
whether the prior use luminosity or absolute magnitude; ``Select
Filter`` at which the luminosity function is computed (a popup window
opens with the available filters in the ``AuxiliaryData/Filters``
directory). Optionally, luminosity can be also corrected for the
intrinsic reddening.

By default, a newly created prior has a single luminosity function for
the total redshift range spanned by the parameter space and for all
the SED templates. Splitting the SED templates in groups and the
redshift range into smaller intervals is done in the popup windows
opened by clicking on the ``Manage SED Groups`` and ``Manage Redshift
Intervals`` buttons.

New SED groups are created with the ``+`` button at the top-right of
the ``Luminosity SED Groups`` popup window. Then, choose the name of
the new group and drag SED templates from the starting group to the
new one (see :numref:`lumprior2`).

Redshift partition requires just to add new redshift values that are
between the range spanned in the parameter space (see
:numref:`lumprior2`).

.. figure:: /_static/advanced_steps/lum_prior_sed_z.png
    :name: lumprior2 
    :width: 800px
    :height: 300px
    :align: center

    Adding new SED (*left panel*) and redshift (*right panel*) groups
	    
Once redshift ranges and SED groups are defined, users have to specify
the luminosity function by clicking on the corresponding cell. A popup
window opens (see :numref:`lumprior3`). There users can provide the
Schechter parameters (clicking ``Schecter``) or selecting a file
storing a luminosity function (clicking ``Custom curve``). In the
latter, top hat luminosity curve can be also generated and used in the
analysis.

.. figure:: /_static/advanced_steps/lum_prior_2pan.png 
    :name: lumprior3
    :width: 800px
    :height: 400px
    :align: center
	    
    Defining the luminosity function in a redshift-SED cell

The GUI gives also the possibility to edit the parameters for all the
Schechter luminosity functions defined in the cells using the ``Bulk
Schechter Edit`` button (:numref:`lumprior4`).

.. figure:: /_static/advanced_steps/lum_prior_schecter.png 
    :name: lumprior4
    :align: center
    :scale: 50 %
	    
    Setting Schechter parameters in redshift-SED cells
	    
Luminosity Priors in the CLI
--------------------------------------

As explained above, in the CLI the luminosity model grid has to be
computed before launching the redshifts computation.

**Luminosity Model Grid** 

The luminosity model grid has to be computed in advance using the
``compute_luminosity_model_grid`` (or ``CLMG``) action. It requires
as input the ``Model Grid`` file and the filter for which the luminosity
function is given. Action parameters for a typical call look like::

  catalog-type=Challenge2
  model-grid-file=Grid_Chalenge2_Parameter_Space_MADAU.dat
  luminosity-filter=EUCLID_DC1/vis
  output-model-grid=Grid_Chalenge2_Parameter_Space_MADAU.dat

The file containing modeled photometry (``model-grid-file``) is
searched in the ``IntermediateProducts/<Catalog Type>/ModelGrids``
directory. The output file (``output-model-grid``) will be stored in
the ``IntermediateProducts/<Catalog Type>/LuminosityModelGrids``
directory, in binary format (by default) or in ASCII if
``--output-model-grid-format=TEXT`` (see :ref:`output_files_format`).

The ``luminosity-filter``
parameter requires the path (below the ``AuxiliaryData/Filters``
directory) and the name of the file containing the filter trasmission
curve which the luminosity function is defined for.



**Redshifts computation configuration**

Luminosity priors are applied in the ``compute_redshift`` (``CR``)
executable through a set of command options. Here below an example of
them.

Global options::

  luminosity-prior=YES
  luminosity-filter=EUCLID_DC1/vis
  luminosity-model-grid-file=Grid_Chalenge2_Parameter_Space_MADAU.dat
  luminosity-function-corrected-for-extinction=NO
  luminosity-function-expressed-in-magnitude=YES

Luminosity priors are enabled only if ``luminosity-prior=YES``
(default is NO). Other parameters specify the filter for the
luminosity functions and the luminosity model grid. In the example, no
reddening correction is applied and magnitude is used (default value
is ``YES``; ``NO`` to select luminosity).
  
Luminosity functions can be different according to SED groups and
redshift intervals. SED groups are defined as::

  luminosity-sed-group-<SED_group_name>=<coma separated SED qualified names>

for example, to define the group named ``Elliptical``::

  luminosity-sed-group-Elliptical=Cosmos/Ell1_A_0,Cosmos/Ell2_A_0,Cosmos/Ell3_A_0,Cosmos/Ell4_A_0,Cosmos/Ell5_A_0,Cosmos/Ell6_A_0,Cosmos/Ell7_A_0

Redshift ranges are defined as::

  luminosity-function-sed-group-<function_id>=<SED_group_name>
  luminosity-function-min-z-<function id>=<z_min>
  luminosity-function-max-z-<function_id>=<z_max>

where ``<function_id>`` is an integer associated to the luminosity
function of a specific SED group and redshift range. For example, here
below, the luminosity function **1** is associated to elliptical
galaxies with redshift between 0 and 2::

  luminosity-function-sed-group-1=Elliptical
  luminosity-function-min-z-1=0
  luminosity-function-max-z-1=2
  luminosity-function-sed-group-2=Elliptical
  luminosity-function-min-z-2=2
  luminosity-function-max-z-2=4

.. note::

   All the SEDs used in the parameter space must be present in one --
   and only one -- group. Moreover, the redshift ranges must span the
   entire range used in the parameter space.
  
The Schechter parametrization, :math:`\alpha_s,~\phi^*` and
:math:`M^*` is set by::

  luminosity-function-schechter-alpha-<function id>=<alpha>
  luminosity-function-schechter-phi0-<function id>=<phi>
  luminosity-function-schechter-m0-<function id>=<m>

For Schechter functions expressed in luminosity, replace ``m0`` by
``l0``.

Alternativelly one can specify pre-computed curves through::
 
  luminosity-function-curve-<function id>=<luminosity funtion qualified filename>

that are searched below the
``AuxialiaryData/LuminosityFunctionCurves`` directory.

An effectiveness value different from 1 can be set with the command
option ``--luminosity-prior-effectiveness`` (see :ref:`effectiveness`).
